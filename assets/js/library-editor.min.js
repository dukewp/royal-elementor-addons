( function( $ ) {

	"use strict";

	// Elementor Editor Popup
	var WprElementorEditorPopup = {

		loaded: false,

		init: function() {
			window.elementor.on( 'preview:loaded', WprElementorEditorPopup.loadPreview );
		},

		loadPreview: function() {
			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/wpr-elementor-template.default', function( $scope ) {
				$scope.find( '.wpr-template-edit-btn' ).on( 'click', WprElementorEditorPopup.renderPopup );
			} );
			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/shortcode.default', function( $scope ) {
				$scope.find( '.wpr-template-edit-btn' ).on( 'click', WprElementorEditorPopup.renderPopup );
			} );

			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/wpr-advanced-slider.default', function( $scope ) {
				$scope.find( '.wpr-template-edit-btn' ).on( 'click', WprElementorEditorPopup.renderPopup );
			} );

			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/wpr-tabs.default', function( $scope ) {
				$scope.find( '.wpr-template-edit-btn' ).on( 'click', WprElementorEditorPopup.renderPopup );
			} );

			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/wpr-content-toggle.default', function( $scope ) {
				$scope.find( '.wpr-template-edit-btn' ).on( 'click', WprElementorEditorPopup.renderPopup );
			} );
		},

		renderPopup: function( link ) {
			// Open Editor
			WprElementorEditorPopup.getPopup().show();

			// Render Iframe
			$( '#wpr-template-editor-popup .dialog-message').html( '<iframe src="' + $( this ).data( 'permalink' ) + '&elementor' + '" id="wpr-template-edit-frame" width="100%" height="100%"></iframe>' );
			
			// Preloading
			$( '#wpr-template-editor-popup .dialog-message').append( '<div id="wpr-template-editor-loading"><div class="elementor-loader-wrapper"><div class="elementor-loader"><div class="elementor-loader-boxes"><div class="elementor-loader-box"></div><div class="elementor-loader-box"></div><div class="elementor-loader-box"></div><div class="elementor-loader-box"></div></div></div><div class="elementor-loading-title">Loading</div></div></div>' );

			// Loaded
			$( '#wpr-template-edit-frame').on( 'load', function() {
				$( '#wpr-template-editor-loading').fadeOut( 300 );
			} );

			// Close
			$( '#wpr-template-editor-popup .dialog-close-button' ).css({
				'right' : '30px',
				'width' : '35px',
				'height' : '35px',
				'line-height' : '30px',
				'border-radius' : '50%',
				'text-align' : 'center',
				'opacity' : '1',
				'background-color' : '#333',
				'box-shadow' : '1px 1px 3px 0 #000',
			}).html('<i class="eicon-close"></i>');

			$( '#wpr-template-editor-popup .dialog-close-button i' ).css({
				'font-size' : '15px',
				'color' : '#fff',
			})

			$( '#wpr-template-editor-popup .dialog-close-button' ).on( 'click', function() {
				elementor.reloadPreview();
			});
		},

		getPopup: function() {

			if ( ! WprElementorEditorPopup.loaded ) {
				this.loaded = elementor.dialogsManager.createWidget( 'lightbox', {
					id: 'wpr-template-editor-popup',
					closeButton: true,
					hide: { onBackgroundClick: false }
				} );
			}

			return WprElementorEditorPopup.loaded;
		}

	};

	$( window ).on( 'elementor:init', WprElementorEditorPopup.init );


	// Modal Popups
	var WprModalPopups = {

		init: function() {
			if ( ! $( 'body' ).hasClass( 'elementor-editor-wpr-popups' ) ) {
				return;
			}

			// Load Preview
			window.elementor.on( 'preview:loaded', WprModalPopups.onPreviewLoad );

			// Change Preview
			window.elementor.on( 'preview:loaded', WprModalPopups.onPreviewChange );

			// Change Controls
			elementor.settings.page.model.on( 'change', WprModalPopups.onControlChange );
		},

		onPreviewLoad: function() {
			// Open Popup Settings
			setTimeout(function() {
				if ( $( '#elementor-panel-footer-settings' ).length ) {
					$( '#elementor-panel-footer-settings' ).trigger( 'click' );
				} else {
					setTimeout(function() {
						$( '#elementor-panel-footer-settings' ).trigger( 'click' );
					}, 5000);
				}
			}, 2000);

			// Popup Settings Notification
			WprModalPopups.settingsNotification();

			// Fix Popup Layout
			window.elementorFrontend.hooks.addAction( 'frontend/element_ready/global', function( $scope ) {
				var popup = $scope.closest( '.wpr-template-popup' );

				WprModalPopups.fixPopupLayout( popup );
			} );
		},

		onPreviewChange: function() {
			// preview change code goes here
		},

		onControlChange: function( model ) {
			var iframe = document.getElementById( 'elementor-preview-iframe' ),
				iframeContent = iframe.contentDocument || iframe.contentWindow.document;

			// Popup
			var popup = $( '.wpr-template-popup', iframeContent );

			// Scrollbar
			if ( model.changed.hasOwnProperty( 'popup_height' ) ) {
				// elementor.reloadPreview();
			}

			// Display As
			if ( model.changed.hasOwnProperty( 'popup_display_as' ) ) {
				if ( 'notification' === model.changed['popup_display_as'] ) {
					popup.addClass( 'wpr-popup-notification' );
				} else {
					popup.removeClass( 'wpr-popup-notification' );
				}
			}

			if ( model.changed.hasOwnProperty( 'popup_display_as' ) ) {

			}

			// Entrance Animation
			if ( model.changed.hasOwnProperty( 'popup_animation' ) ) {
				var popupContainer = popup.find('.wpr-popup-container');

				popupContainer.removeAttr( 'class');
				popupContainer.addClass( 'wpr-popup-container animated '+ model.changed['popup_animation'] );
			}
		},

		fixPopupLayout: function( popup ) {
			var settings = WprModalPopups.getDocumentSettings();

			// Add Scrollbar
			if ( ! popup.find('.wpr-popup-container-inner').hasClass('ps') ) {
				const ps = new PerfectScrollbar(popup.find('.wpr-popup-container-inner')[0], {
					suppressScrollX: true
				});
			}

			if ( 'notification' === settings.popup_display_as ) {
				popup.addClass( 'wpr-popup-notification' );
			}
		},

		getDocumentSettings: function() {
			var documentSettings = {},
				settings = elementor.settings.page.model;

			jQuery.each(settings.getActiveControls(), function (controlKey) {
				documentSettings[controlKey] = settings.attributes[controlKey];
			});

			return documentSettings;
		},

		settingsNotification: function() {
			var version = $('#wpr-addons-editor-js-js').attr('src');
				version = 'v-'+ version.substring(version .length - 6, version .length);

			// Get Close Time
			var closeTime = JSON.parse( localStorage.getItem( 'WprPopupEditorNotification'+ version) ) || {};

			if ( closeTime + 604800000 >= Date.now() ) {
				return;
			}

			// Notification HTML
			var nHTML = '\
				<div id="wpr-template-settings-notification">\
					<h4><i class="eicon-info-circle"></i><span>Please Note</span></h4>\
					<p>Click here to access <strong>Popup Settings</strong>.<br>Click our Logo to the right to open a <strong>Popup Library</strong>.</p>\
					<i class="eicon-close"></i>\
				</div>\
			';

			// Render Notification
			$( 'body' ).append( nHTML ).hide().fadeIn();

			// Hide on Click
			$( '#wpr-template-settings-notification .eicon-close' ).on( 'click', function() {
				$( '#wpr-template-settings-notification' ).fadeOut();

				// Save Close Time in Browser
				localStorage.setItem( 'WprPopupEditorNotification'+ version, Date.now() );
			});
		},
	};

	$( window ).on( 'elementor:init', WprModalPopups.init );


	// Theme Builder
	var WprThemeBuilder = {

		init: function() {
			if ( ! $( 'body' ).hasClass( 'elementor-editor-wpr-theme-builder' ) ) {
				return;
			}

			// Load Preview
			window.elementor.on( 'preview:loaded', WprThemeBuilder.onPreviewLoad );
		},

		onPreviewLoad: function() {

			// Popup Settings Notification
			WprThemeBuilder.settingsNotification();

			// Submit Preview Changes
			$( '#elementor-panel-footer-settings' ).on( 'click', function() {
				setTimeout(function() {
					$( '.elementor-control-submit_preview_changes button' ).on( 'click', function() {
						$e.run('document/save/auto', {
						force: true,
							onSuccess: function onSuccess() {
								elementor.reloadPreview();
								elementor.once('preview:loaded', function () {
									$e.route('panel/page-settings/settings');
								});
							}
						});
					});
				}, 500);
			});

		},

		settingsNotification: function() {
			var version = $('#wpr-addons-editor-js-js').attr('src');
				version = 'v-'+ version.substring(version .length - 6, version .length);

			// Get Close Time
			var closeTime = JSON.parse( localStorage.getItem('WprThemeBuilderNotification'+ version) ) || {};

			if ( closeTime + 604800000 >= Date.now() ) {
				return;
			}

			// Notification HTML
			var nHTML = '\
				<div id="wpr-template-settings-notification">\
					<h4><i class="eicon-info-circle"></i><span>Please Note</span></h4>\
					<p>You can change <strong>Preview Settings</strong> here.</p>\
					<i class="eicon-close"></i>\
				</div>\
			';

			setTimeout(function() {
				// Render Notification
				if ( !$('#wpr-template-settings-notification').length ) {
					$('body').append(nHTML).hide().fadeIn();

					// Set Close Time
					$(document).on( 'click', function() {
						$('#wpr-template-settings-notification').fadeOut();
					});

					// Hide on Click
					$('#wpr-template-settings-notification .eicon-close').on( 'click', function() {
						$( '#wpr-template-settings-notification' ).fadeOut();

						// Save Close Time in Browser
						localStorage.setItem( 'WprThemeBuilderNotification'+ version, Date.now() );
					});
				}
			}, 1000 );
		},
	};

	$( window ).on( 'elementor:init', WprThemeBuilder.init );
    
	// Dynamic Progress Bar for Elementor Editor
    $(window).on('elementor:init', function () {
        
        elementor.settings.page.addChangeCallback( 'wpr_rpb_enable', function ( newValue ) {
			console.log(newValue);
            if('yes' == newValue ) {
                let wrpbHtml = '<div class="wpr-reading-progress-bar-container"><div class="wpr-reading-progress-bar wpr-mybar" id="wpr-mybar"></div></div>';
                $( elementorFrontend.elements.$body ).append( wrpbHtml );
            } else {
                if ( $( elementorFrontend.elements.$body ).find( '.wpr-reading-progress-bar-container' ).length ) {
                    $( elementorFrontend.elements.$body ).find( '.wpr-reading-progress-bar-container' ).remove();
                }
            }
        });

    });
    
	// Create Template from elementor controls

	$(window).on('elementor:init', function() {
	});

    $(window).on('elementor:init', );

	var WprCreateTemplateForAccordion =  {
		init: function() {
			elementor.channels.editor.on('section:activated', WprCreateTemplateForAccordion.checkLiveTemplateControl);
			WprCreateTemplateForAccordion.handleLiveEditor();
		},

		handleLiveEditor: function() {

			$('.eicon-close').on('click', WprCreateTemplateForAccordion.closeModal);
	
			$('#wpr-insert-live-temp').on('click', function () {
				$('body').attr('data-wpr-live-editor-load', 'true');
				WprCreateTemplateForAccordion.closeModal(true);
			});
	
			$('.wpr-live-editor-iframe-modal .wpr-expand-editor').on('click', function () {
	
				if ($(this).find(' > i').hasClass('eicon-frame-expand')) {
					$(this).find('i.eicon-frame-expand').removeClass('eicon-frame-expand').addClass('eicon-frame-minimize').attr('title', 'Minimize');
					$('.wpr-live-editor-iframe-modal').addClass('premium-modal-expanded');
	
				} else {
					WprCreateTemplateForAccordion.minimizeModal(this);
				}
			});
	
			$(document).on('click', '.wpr-live-editor-iframe-modal', function (e) {
				if ($(e.target).closest(".dialog-lightbox-widget-content").length < 1) {
					WprCreateTemplateForAccordion.closeModal();
				}
			});
	
			elementor.channels.editor.on('createLiveTemp', function (e) {
	
				var widgetId = WprCreateTemplateForAccordion.getTemplateKey(e),
					$modalContainer = $('.wpr-live-editor-iframe-modal'),
					paIframe = $modalContainer.find("#wpr-live-editor-control-iframe"),
					$lightboxLoading = $modalContainer.find(".dialog-lightbox-loading"),
					lightboxType = $modalContainer.find(".dialog-type-lightbox"),
					tempSelectorId = e.model.attributes.name.split('_live')[0],
					liveTempId = ['premium_content_toggle_second_content_templates', 'fixed_template', 'right_side_template'].includes(tempSelectorId) ? 'live_temp_content_extra' : 'live_temp_content',
					settingsToChange = {};
	
				// multiscroll has two temps in each repeater item => both temps will have the same id so we need to distinguish one of them.
				if ('right_side_template' === tempSelectorId) {
					widgetId += '2';
				}
	
				// show modal.
				lightboxType.show();
				$modalContainer.show();
				$lightboxLoading.show();
				paIframe.contents().find("#elementor-loading").show();
				paIframe.css("z-index", "-1");
	
				$.ajax({
					type: 'POST',
					url: WprLibraryEditor.ajaxurl,
					dataType: 'JSON',
					data: {
						action: 'handle_live_editor',
						security: WprLibraryEditor.nonce,
						key: widgetId,
					},
					success: function (res) {
	
						paIframe.attr("src", res.data.url);
						paIframe.attr("data-wpr-temp-id", res.data.id);
						$('#wpr-live-temp-title').val(res.data.title);
	
						paIframe.on("load", function () {
							$lightboxLoading.hide();
							paIframe.show();
							$modalContainer.find('.premium-live-editor-title').css('display', 'flex');
							paIframe.contents().find("#elementor-loading").hide();
							paIframe.css("z-index", "1");
						});
	
						clearInterval(window.wprLiveEditorInterval);
	
						window.wprLiveEditorInterval = setInterval(function () {
	
							var loadTemplate = $('body').attr('data-wpr-live-editor-load');
	
							if ('true' === loadTemplate) {
								$('body').attr('data-wpr-live-editor-load', 'false');
	
								settingsToChange[tempSelectorId] = '';
								settingsToChange[liveTempId] = $('#wpr-live-temp-title').val();
	
								$(".wpr-live-temp-title").removeClass("control-hidden");
								$e.run('document/elements/settings', { container: e.container, settings: settingsToChange, options: { external: !0 } });
	
								var tempTitle = $('#wpr-live-temp-title').val();
	
								if (tempTitle && tempTitle !== res.data.title) {
									WprCreateTemplateForAccordion.updateTemplateTitle(tempTitle, res.data.id);
								}
							}
						}, 1000);
					},
					error: function (err) {
						console.log(err);
					}
				});
			});
		},

		checkTempValidity: function(tempID) {

			if ('' !== tempID) {
				$.ajax({
					type: 'POST',
					url: WprLibraryEditor.ajaxurl,
					dataType: 'JSON',
					data: {
						action: 'check_temp_validity',
						security: WprLibraryEditor.nonce,
						templateID: tempID,
					},
					success: function (res) {
						console.log(res.data);
					},
					error: function (err) {
						console.log(err);
					}
				});
			}
		},

		
		getTemplateKey: function(e) {
			var widget = e.options.container.view.$el,
				// control_id = e._parent.model.attributes._id ? e._parent.model.attributes._id : e.model.cid;
				control_id = e._parent.model.attributes._id ? e._parent.model.attributes._id : '';
	
			return widget.data('id') + control_id;
		},
	
		minimizeModal: function(_this) {
	
			$(_this).find('i.eicon-frame-minimize').removeClass('eicon-frame-minimize').addClass('eicon-frame-expand').attr('title', 'Expand');
			$('.wpr-live-editor-iframe-modal').removeClass('premium-modal-expanded');
		},

		updateTemplateTitle: function(title, id) {

			$.ajax({
				type: 'POST',
				url: WprLibraryEditor.ajaxurl,
				dataType: 'JSON',
				data: {
					action: 'update_template_title',
					security: WprLibraryEditor.nonce,
					title: title,
					id: id
				},
				success: function (res) {
					console.log('Template Title Updated.');
				},
				error: function (err) {
					console.log(err);
				}
			});
		},
	
		closeModal: function(inserted = false) {
	
			$('.wpr-live-editor-iframe-modal').css('display', 'none');
	
			$(".wpr-live-temp-title input").attr('disabled', 'true');
	
			WprCreateTemplateForAccordion.minimizeModal($('.wpr-live-editor-iframe-modal .wpr-expand-editor'));
	
			if (!inserted) {
				var tempId = $(".wpr-live-editor-iframe-modal #wpr-live-editor-control-iframe").attr('data-wpr-temp-id');
	
				if (undefined !== tempId && '' !== tempId) {
					WprCreateTemplateForAccordion.checkTempValidity(tempId);
				}
			}
	
			// reset temp id/src attribute.
			$(".wpr-live-editor-iframe-modal #wpr-live-editor-control-iframe").attr({
				'data-wpr-temp-id': '',
				'src': ''
			});
		},
	
		checkLiveTemplateControl: function(sectionName, elementorEditor) {
	
			setTimeout(function () {
	
				$(".wpr-live-temp-title input").each(function (index, input) {
					$(input).attr('disabled', 'true');
					if ('' != $(input).val()) {
						$(input).closest(".wpr-live-temp-title").removeClass("control-hidden");
					}
				});
	
			}, 1000);
		}
	}

	$( window ).on( 'elementor:init', WprCreateTemplateForAccordion.init );

}( jQuery ) );
